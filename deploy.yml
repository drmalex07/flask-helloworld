---

 # Note: The docker-related commands can also be written using the relevant
 # Ansible module (http://docs.ansible.com/ansible/docker_image_module.html).
 # But, at the time this was written, no support for build-arg, so we fallback to
 # plain shell commands

 - hosts: 127.0.0.1
   connection: local

   pre_tasks:
    
   - name: Determine the current version
     set_fact:
       version: '{{lookup("file", "VERSION")}}'

   - name: Generate a session secret (16 bytes)
     shell: head -c16 /dev/urandom| base64
     register: urandom_result
   - set_fact:
       session_secret: '{{urandom_result.stdout}}'

   tasks:
   
   - name: Create image for apache2 with WSGI module
     shell: >
       docker build -t 'local/httpd:2.4-mod_wsgi' -f deploy/httpd/Dockerfile .
   
   - name: Create image for data volume container
     shell: >
       docker build -t 'local/helloworld-data:{{version}}' -f deploy/app-data/Dockerfile .
  
   - name: Generate config file for the helloworld application
     template: src=deploy/app/config.ini.j2 dest=deploy/app/config.ini force=no

   - name: Create image for the helloworld application
     shell: >
       docker build -t 'local/helloworld:{{version}}' -f deploy/app/Dockerfile --build-arg 'version={{version}}' .


